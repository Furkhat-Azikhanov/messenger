<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Simple Messenger</title>
  <meta name="theme-color" content="#111b21" />
  <link rel="manifest" href="/static/manifest.json" />
  <link rel="apple-touch-icon" href="/static/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root {
      --bg: #0b141a;
      --panel: #111b21;
      --panel-2: #202c33;
      --accent: #25d366;
      --accent-2: #128c7e;
      --text: #e9edef;
      --sub: #8696a0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    .app {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: 1fr;
      background: linear-gradient(180deg, #0b141a 0%, #0b141a 60%, #111b21 60%, #111b21 100%);
    }
    header {
      grid-column: 1 / -1;
      background: var(--panel);
      padding: 14px 18px;
      border-bottom: 1px solid #1f2c33;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }
    #status { color: var(--sub); font-size: 14px; }
    .header-actions { display: flex; gap: 8px; }
    .header-actions button { background: #2a3942; color: var(--text); font-weight: 600; }
    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: calc(100vh - 54px);
      min-height: calc(100dvh - 54px);
      align-items: stretch;
    }
    .auth-landing {
      display: none;
      min-height: calc(100dvh - 54px);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .auth-landing .card {
      background: var(--panel);
      border: 1px solid #1f2c33;
      border-radius: 12px;
      padding: 18px 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .sidebar {
      background: var(--panel);
      border-right: 1px solid #1f2c33;
      display: flex;
      flex-direction: column;
    }
    .auth {
      padding: 12px 14px;
      border-bottom: 1px solid #1f2c33;
    }
    .auth h2, .contacts h2 { margin: 0 0 8px; font-size: 15px; font-weight: 600; color: var(--text); }
    label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--sub); }
    input {
      width: 100%;
      padding: 8px 10px;
      margin-top: 3px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #2a3942;
      background: #111b21;
      color: var(--text);
    }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: var(--accent-2);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #2a3942; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; }
    .row input { flex: 1; margin-bottom: 0; }
    .status { font-size: 13px; color: var(--sub); margin-top: 4px; }
    .hidden { display: none !important; }

    .contacts { flex: 1; overflow-y: auto; }
    #users { display: flex; flex-direction: column; }
    #users button {
      background: transparent;
      color: var(--text);
      border-radius: 0;
      border: none;
      border-bottom: 1px solid #1f2c33;
      text-align: left;
      padding: 12px 14px;
      font-weight: 500;
    }
    #users button:hover { background: #1f2c33; }
    #users button.active { background: #2a3942; }
    .section-label { padding: 8px 14px; font-size: 12px; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }

    .chat-area {
      background: var(--panel);
      position: relative;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 54px);
      min-height: calc(100dvh - 54px);
    }
    .chat-header {
      background: var(--panel-2);
      border-bottom: 1px solid #1f2c33;
      display: flex;
      align-items: center;
      padding: 0 18px;
      justify-content: space-between;
    }
    .chat-meta { display: flex; flex-direction: column; }
    .chat-meta .name { font-weight: 600; }
    .chat-meta .hint { color: var(--sub); font-size: 13px; }
    .call-buttons { display: flex; gap: 8px; }
    .call-buttons button { background: #2a3942; color: var(--text); }
    .call-buttons button.end { background: #b3261e; color: #fff; }
    .chat-menu { background: #2a3942; color: var(--text); border-radius: 6px; padding: 6px 8px; cursor: pointer; }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 22px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.02), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(255,255,255,0.025), transparent 30%),
        linear-gradient(135deg, rgba(255,255,255,0.01) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.01) 50%, rgba(255,255,255,0.01) 75%, transparent 75%, transparent);
      background-size: 280px 280px, 260px 260px, 18px 18px;
      background-color: #0d141a;
    }
    .group-info {
      background: rgba(15, 24, 31, 0.92);
      border-top: 1px solid #1f2c33;
      border-bottom: 1px solid #1f2c33;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      min-height: 28px;
      height: auto;
      box-sizing: border-box;
      align-self: stretch;
      margin-top: 4px;
    }

    .group-info.hidden { display: none; }
    .group-info .members-list {
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
      flex: 1;
      max-height: 120px;
    }
    .group-info .member { display: block; color: #e9edef; }
    .group-info strong { color: #e9edef; }
    .group-info .close { cursor: pointer; color: #e9edef; padding: 2px 6px; background: #2a3942; border-radius: 6px; font-size: 11px; flex-shrink: 0; }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 10px;
      background: #2ecc71;
      color: #0b141a;
      font-size: 12px;
      font-weight: 700;
    }
    .online-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-left: 6px;
      border-radius: 50%;
      background: #2ecc71;
    }
    .call-area { display: none; gap: 10px; padding: 10px 12px 6px; }
    .call-area.active { display: flex; }
    .call-area .video-box {
      position: relative;
      background: #0b141a;
      border: 1px solid #1f2c33;
      border-radius: 10px;
      overflow: hidden;
      min-height: 160px;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #111;
    }
    .video-label {
      position: absolute;
      bottom: 6px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }
    .msg {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 10px;
      position: relative;
      color: #111;
      line-height: 1.3;
    }
    .me {
      margin-left: auto;
      background: #d9fdd3;
      border-top-right-radius: 2px;
    }
    .other {
      margin-right: auto;
      background: #fff;
      border-top-left-radius: 2px;
    }
    .bubble-info {
      font-size: 11px;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      background: var(--panel-2);
      border-top: 1px solid #1f2c33;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
    }
    .chat-input input {
      background: #2a3942;
      border: 1px solid #2f3b43;
      color: var(--text);
    }
    .chat-input button { background: var(--accent); color: #111; font-weight: 700; }
    .attach-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 38px;
      border-radius: 8px;
      background: #2a3942;
      border: 1px solid #2f3b43;
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
    }
    #file-input { display: none; }
    .attachment {
      margin-top: 6px;
    }
    .attachment img {
      max-width: 220px;
      border-radius: 8px;
      display: block;
    }
    .attachment video {
      max-width: 260px;
      border-radius: 8px;
      display: block;
    }
    .attachment a {
      color: #0f9af0;
      word-break: break-all;
    }
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2a3942;
      border: 1px solid #2f3b43;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      max-width: 240px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .file-chip.hidden { display: none; }
    .file-chip button {
      background: transparent;
      color: var(--text);
      border: none;
      padding: 0 4px;
      cursor: pointer;
      font-weight: 700;
    }

    .auth-overlay {
      display: none; /* –æ—Ç–∫–ª—é—á–∞–µ–º –æ–≤–µ—Ä–ª–µ–π, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª —Ñ–æ—Ä–º—É */
    }
    .auth-overlay .box {
      background: #111b21;
      border: 1px solid #1f2c33;
      border-radius: 12px;
      padding: 18px 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .auth-overlay h2 { margin: 0 0 8px; }
    .auth-overlay p { margin: 0; color: var(--sub); }

    /* --- –ê–¥–∞–ø—Ç–∏–≤ –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ --- */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        height: calc(100vh - 54px);
        position: relative;
      }
      .sidebar {
        position: absolute;
        width: 100%;
        height: calc(100vh - 54px);
        z-index: 3;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
      }
      .sidebar.show {
        transform: translateX(0);
        box-shadow: 4px 0 14px rgba(0,0,0,0.35);
      }
      .chat-area {
        grid-template-rows: 60px 1fr 70px;
      }
      .call-area {
        flex-direction: column;
        padding: 8px 12px 4px;
      }
      .chat-header {
        gap: 10px;
      }
      .mobile-only { display: inline-flex !important; }
      .desktop-only { display: none !important; }
    }
    .mobile-only { display: none; }
    .desktop-only { display: inline-flex; }

    /* FIX: —Ç–µ–∫—Å—Ç –∏–º—ë–Ω —Ä—è–¥–æ–º —Å —á–µ–∫–±–æ–∫—Å–æ–º –Ω–∞ iOS */
    #group-member-picker label,
    #group-member-picker label span {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
    }


  </style>
</head>
<body>
  <div class="app">
    <header>
      <div id="status">Not connected</div>
      <div class="header-actions">
        <button class="mobile-only hidden" id="toggle-contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
        <button class="hidden" id="btn-logout">–í—ã–π—Ç–∏</button>
      </div>
    </header>
    <div id="auth-landing" class="auth-landing">
      <div class="card">
        <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <label>–õ–æ–≥–∏–Ω <input id="landing-username" /></label>
        <label>–ü–∞—Ä–æ–ª—å <input id="landing-password" type="password" /></label>
        <div class="row" style="margin-top:6px;">
          <button class="secondary" id="landing-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          <button id="landing-login">–í–æ–π—Ç–∏</button>
        </div>
        <div class="status" id="landing-auth-status"></div>
      </div>
    </div>
    <main>
      <aside class="sidebar" id="sidebar">
        <div class="auth">
          <h2>–ê–∫–∫–∞—É–Ω—Ç</h2>
          <label>–õ–æ–≥–∏–Ω <input id="username" /></label>
          <label>–ü–∞—Ä–æ–ª—å <input id="password" type="password" /></label>
          <div class="row" style="margin-top:6px;">
            <button class="secondary" id="btn-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button id="btn-login">–í–æ–π—Ç–∏</button>
          </div>
          <div class="status" id="auth-status"></div>
        </div>
        <div class="contacts">
          <h2 style="padding:10px 14px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
          <div class="status" style="padding:0 14px 6px;">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
          <div id="users"></div>
          <div id="groups-block">
            <div class="status" style="padding:0 14px 6px; margin-top:8px;">–ì—Ä—É–ø–ø—ã</div>
            <div id="groups"></div>
            <div style="padding:10px 14px;">
              <input id="group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" />
              <div id="group-member-picker" style="max-height:140px; overflow-y:auto; border:1px solid #2a3942; border-radius:8px; padding:8px; margin-top:6px; text-align:left; color:#e9edef; font-size:13px; background:#111b21;"></div>
              <button style="margin-top:6px;" id="btn-create-group">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
              <div class="status">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ—Å—å —Å–∞–º–∏. –û—Ç–º–µ—Ç—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞.</div>
            </div>
          </div>
        </div>
      </aside>

      <section class="chat-area">
        <div class="chat-header">
          <div class="chat-meta">
            <span class="name" id="chat-title">–ß–∞—Ç</span>
            <span class="hint" id="chat-status">–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</span>
          </div>
          <div class="call-buttons">
            <button id="call-audio">–ê—É–¥–∏–æ</button>
            <button id="call-video">–í–∏–¥–µ–æ</button>
            <button class="end" id="call-end">–°–±—Ä–æ—Å</button>
            <button class="chat-menu hidden" id="group-menu">‚ãÆ</button>
          </div>
        </div>
        <div class="group-info hidden" id="group-info">
          <div class="members-list"></div>
          <div class="close" id="group-info-close">√ó</div>
        </div>

        <div class="call-area">
          <div class="video-box">
            <video id="remoteVideo" playsinline autoplay></video>
            <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
          </div>
          <div class="video-box">
            <video id="localVideo" muted playsinline autoplay></video>
            <div class="video-label">–í—ã</div>
          </div>
        </div>

        <div id="chat"></div>

        <div class="chat-input">
          <label for="file-input" class="attach-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</label>
          <input type="file" id="file-input" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar" />
          <div id="file-chip" class="file-chip hidden"></div>
          <input id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>
    </main>
    <div class="auth-overlay hidden" id="auth-overlay">
      <div class="box">
        <h2>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</h2>
        <p>–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏ –∑–≤–æ–Ω–∫–∏, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ —Ñ–æ—Ä–º–µ —Å–ª–µ–≤–∞.</p>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const authStatus = document.getElementById('auth-status');
    const usersEl = document.getElementById('users');
    const groupsEl = document.getElementById('groups');
    const chatEl = document.getElementById('chat');
    const chatTitle = document.getElementById('chat-title');
    const chatStatus = document.getElementById('chat-status');
    const messageInput = document.getElementById('message-input');
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    const authBlock = document.querySelector('.auth');
    const authLanding = document.getElementById('auth-landing');
    const landingAuthStatus = document.getElementById('landing-auth-status');
    const logoutBtn = document.getElementById('btn-logout');
    const authOverlay = document.getElementById('auth-overlay');
    const groupsBlock = document.getElementById('groups-block');
    const groupMemberPicker = document.getElementById('group-member-picker');
    const groupMenuBtn = document.getElementById('group-menu');
    const groupInfo = document.getElementById('group-info');
    const groupInfoClose = document.getElementById('group-info-close');
    const callArea = document.querySelector('.call-area');
    const fileInputEl = document.getElementById('file-input');
    const fileChip = document.getElementById('file-chip');

    let token = localStorage.getItem('token') || '';
    let me = null;
    let ws = null;
    let currentPeer = null;
    let currentGroup = null;
    const conversations = {};
    let usersCache = [];
    let groupsCache = [];
    const groupMembersCache = {};
    const onlineUsers = new Set();
    let pc = null;
    let localStream = null;
    let currentMedia = 'audio';
    const unreadUsers = new Map();   // userId -> count
    const unreadGroups = new Map();  // groupId -> count
    const typingTimers = new Map();
    const groupTypingTimers = new Map();
    const messageQueue = [];
    let reconnectTimer = null;
    let reconnectAttempts = 0;
    let isTypingSent = false;
    let heartbeatTimer = null;
    const audioCtx = window.AudioContext ? new AudioContext() : null;
    let audioUnlocked = false;
    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
      ],
    };
    const sidebar = document.getElementById('sidebar');
    const toggleContactsBtn = document.getElementById('toggle-contacts');
    let isMobile = window.matchMedia('(max-width: 900px)').matches;

    function updateSidebar(show) {
      if (!isMobile) return;
      if (show) sidebar.classList.add('show');
      else sidebar.classList.remove('show');
    }

    window.matchMedia('(max-width: 900px)').addEventListener('change', (e) => {
      isMobile = e.matches;
      if (!isMobile) updateSidebar(false);
    });

    function setStatus(text) { statusEl.textContent = text; }
    function setAuthStatus(text) {
      authStatus.textContent = text;
      if (landingAuthStatus) landingAuthStatus.textContent = text;
    }
    function setChatStatus(text) { chatStatus.textContent = text; }
    function totalUnread() {
      let sum = 0;
      unreadUsers.forEach((v) => { sum += v; });
      unreadGroups.forEach((v) => { sum += v; });
      return sum;
    }
    function updateTitleBadge() {
      const n = totalUnread();
      document.title = n > 0 ? `(${n}) Messenger` : 'Simple Messenger';
    }
    function playBeep() {
      if (!audioCtx) return;
      if (!audioUnlocked) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
    }
    function requestNotifyPermission() {
      if (typeof Notification === 'undefined') return;
      if (Notification.permission === 'default') {
        Notification.requestPermission().catch(() => {});
      }
    }
    function maybeNotify(title, body) {
      if (typeof Notification === 'undefined') return;
      if (Notification.permission === 'granted') {
        try { new Notification(title, { body }); } catch (_) {}
      } else if (Notification.permission === 'default') {
        requestNotifyPermission();
      } else {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö Safari —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ push, –¥–µ–ª–∞–µ–º –≤–∏–±—Ä–∞—Ü–∏—é
        if (navigator.vibrate) navigator.vibrate(150);
      }
    }

    function ensureAudioUnlocked() {
      if (!audioCtx || audioUnlocked) return;
      const resume = () => {
        audioCtx.resume().then(() => {
          audioUnlocked = true;
          document.removeEventListener('touchstart', resume, true);
          document.removeEventListener('click', resume, true);
        }).catch(() => {});
      };
      document.addEventListener('touchstart', resume, true);
      document.addEventListener('click', resume, true);
    }
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    async function ensurePushSubscribed() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      try {
        const reg = await navigator.serviceWorker.ready;
        const { publicKey } = await api('/push/public_key');
        if (!publicKey) return;
        let sub = await reg.pushManager.getSubscription();
        if (!sub) {
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });
        }
        await api('/push/subscribe', { method: 'POST', body: JSON.stringify(sub) });
      } catch (e) {
        console.warn('push subscribe failed', e);
      }
    }
    async function unsubscribePush() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      try {
        const reg = await navigator.serviceWorker.ready;
        const sub = await reg.pushManager.getSubscription();
        if (sub) {
          await api('/push/unsubscribe', {
            method: 'POST',
            body: JSON.stringify({ endpoint: sub.endpoint }),
          }).catch(() => {});
          await sub.unsubscribe();
        }
      } catch (e) {
        console.warn('push unsubscribe failed', e);
      }
    }
    function usernameById(id, groupId = null) {
      if (!id) return 'User';
      if (me && id === me.id) return me.username || '–í—ã';
      const found = usersCache.find(u => u.id === id);
      if (found) return found.username;
      if (groupId && groupMembersCache[groupId]) {
        const m = groupMembersCache[groupId].find(x => x.user_id === id);
        if (m) return m.username;
      }
      return `User ${id}`;
    }
    function showAuth() {
      if (authBlock) authBlock.classList.remove('hidden');
      if (authLanding) authLanding.style.display = 'flex';
      if (document.querySelector('main')) document.querySelector('main').style.display = 'none';
      if (logoutBtn) logoutBtn.classList.add('hidden');
      if (toggleContactsBtn) toggleContactsBtn.classList.add('hidden');
      if (groupsBlock) groupsBlock.classList.add('hidden');
      // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞
      updateSidebar(true);
    }
    function hideAuth() {
      if (authBlock) authBlock.classList.add('hidden');
      if (authLanding) authLanding.style.display = 'none';
      if (document.querySelector('main')) document.querySelector('main').style.display = 'grid';
      if (logoutBtn) logoutBtn.classList.remove('hidden');
      if (toggleContactsBtn) toggleContactsBtn.classList.remove('hidden');
      if (groupsBlock) groupsBlock.classList.remove('hidden');
      // –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –Ω–∞ –º–æ–±–∏–ª–∫–µ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
      updateSidebar(isMobile ? true : false);
    }

    function updateGroupMenuVisibility() {
      if (!groupMenuBtn) return;
      if (currentGroup && me) {
        const g = groupsCache.find(x => x.id === currentGroup);
        if (g && g.owner_id === me.id) {
          groupMenuBtn.classList.remove('hidden');
          return;
        }
      }
      groupMenuBtn.classList.add('hidden');
    }

    function clearVideos() {
      if (remoteVideo) remoteVideo.srcObject = null;
      if (localVideo) localVideo.srcObject = null;
    }

    function cleanupCall(notify = false) {
      if (pc) {
        pc.ontrack = null;
        pc.onicecandidate = null;
        pc.onconnectionstatechange = null;
        pc.close();
      }
      pc = null;
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
      }
      localStream = null;
      clearVideos();
      if (callArea) callArea.classList.remove('active');
      if (notify && currentPeer) {
        sendSignal({ signal_type: 'end' });
      }
      setChatStatus('–ì–æ–ª–æ—Å/–≤–∏–¥–µ–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã');
    }

    function startHeartbeat() {
      stopHeartbeat();
      heartbeatTimer = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'ping' }));
        }
      }, 20000);
    }

    function stopHeartbeat() {
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = null;
    }

    function enqueueMessage(payload) {
      messageQueue.push(payload);
    }

    function flushQueue() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      while (messageQueue.length) {
        const msg = messageQueue.shift();
        ws.send(JSON.stringify(msg));
      }
    }

    function scheduleReconnect() {
      if (reconnectTimer || !token) return;
      const delay = Math.min(15000, 1000 * Math.pow(2, reconnectAttempts));
      reconnectAttempts += 1;
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connectWs();
      }, delay);
    }

    function sendSignal(payload) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !currentPeer) return;
      ws.send(JSON.stringify({ type: 'signal', receiver_id: currentPeer, ...payload }));
    }

    async function ensureLocalStream(media) {
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
      }
      const constraints = { audio: true, video: media === 'video' };
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      if (localVideo) localVideo.srcObject = localStream;
    }

    function createPeer(media) {
      currentMedia = media;
      pc = new RTCPeerConnection(rtcConfig);
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          sendSignal({ signal_type: 'ice', candidate: event.candidate.toJSON() });
        }
      };
      pc.ontrack = (event) => {
        if (remoteVideo) remoteVideo.srcObject = event.streams[0];
      };
      pc.onconnectionstatechange = () => {
        setChatStatus(`Call state: ${pc.connectionState}`);
        if (['failed', 'disconnected', 'closed'].includes(pc.connectionState)) {
          cleanupCall();
        }
      };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      return pc;
    }

    async function startCall(media) {
      if (!currentPeer) return setChatStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
      try {
        cleanupCall();
        await ensureLocalStream(media);
        createPeer(media);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({ signal_type: 'offer', sdp: offer, media });
        setChatStatus(media === 'video' ? '–í–∏–¥–µ–æ –≤—ã–∑–æ–≤...' : '–ê—É–¥–∏–æ –≤—ã–∑–æ–≤...');
        if (callArea) callArea.classList.add('active');
      } catch (e) {
        setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ' + e.message);
        cleanupCall();
      }
    }

    async function handleOffer(data) {
      try {
        // –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª –∑–≤–æ–Ω–æ–∫ –æ—Ç –¥—Ä—É–≥–æ–≥–æ, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ–≥–æ
        if (currentPeer !== data.sender_id) {
          const found = usersCache.find(u => u.id === data.sender_id) || { id: data.sender_id, username: 'User ' + data.sender_id };
          await openChat(found);
        }
        cleanupCall();
        await ensureLocalStream(data.media || 'audio');
        createPeer(data.media || 'audio');
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendSignal({ signal_type: 'answer', sdp: answer, media: data.media || 'audio' });
        setChatStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
        if (callArea) callArea.classList.add('active');
      } catch (e) {
        setChatStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∑–≤–æ–Ω–æ–∫: ' + e.message);
        cleanupCall(true);
      }
    }

    async function handleAnswer(data) {
      if (!pc) return;
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        setChatStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      } catch (e) {
        setChatStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + e.message);
      }
    }

    function handleIce(data) {
      if (!pc || !data.candidate) return;
      pc.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(console.error);
    }

    async function deleteCurrentGroup() {
      if (!currentGroup) return;
      const g = groupsCache.find(x => x.id === currentGroup);
      if (!g) return;
      if (g.owner_id !== (me && me.id)) {
        setChatStatus('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É');
        return;
      }
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) return;
      try {
        await api(`/groups/${currentGroup}`, { method: 'DELETE' });
        handleGroupDeleted(currentGroup);
        await loadGroups();
      } catch (e) {
        setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É: ' + e.message);
      }
    }

    async function api(path, options = {}) {
      const headers = options.headers || {};
      if (token) headers['Authorization'] = `Bearer ${token}`;
      if (options.body && !headers['Content-Type']) headers['Content-Type'] = 'application/json';
      const res = await fetch(path, { ...options, headers });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || res.statusText);
      }
      if (res.headers.get('content-type')?.includes('application/json')) {
        return res.json();
      }
      return res.text();
    }

    function renderUsers(users) {
      usersCache = users;
      usersEl.innerHTML = '';
      if (me) {
        const fav = document.createElement('button');
        fav.textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (–∑–∞–º–µ—Ç–∫–∏)';
        fav.onclick = () => openChat({ id: me.id, username: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' });
        if (currentPeer === me.id && !currentGroup) fav.classList.add('active');
        usersEl.appendChild(fav);
      }
      users
        .filter(u => !me || u.id !== me.id)
        .forEach(u => {
          const btn = document.createElement('button');
          btn.textContent = u.username;
          if (onlineUsers.has(u.id)) {
            const dotOnline = document.createElement('span');
            dotOnline.className = 'online-dot';
            btn.appendChild(dotOnline);
          }
          const count = unreadUsers.get(u.id) || 0;
          if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = count;
            btn.appendChild(badge);
          }
          btn.onclick = () => openChat(u);
          if (u.id === currentPeer && !currentGroup) btn.classList.add('active');
          usersEl.appendChild(btn);
        });
    }

    function renderGroupMemberPicker() {
      if (!groupMemberPicker) return;
      groupMemberPicker.innerHTML = '';
      const list = usersCache.filter(u => !me || u.id !== me.id);
      list.forEach(u => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '6px';
        label.style.margin = '4px 0';
        label.style.color = '#ffffff';
        label.style.fontSize = '13px';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = u.username;
        label.appendChild(cb);

        const text = document.createElement('span');
        text.textContent = u.username;
        text.style.color = '#ffffff';
        label.appendChild(text);

        groupMemberPicker.appendChild(label);
      });
      if (!list.length) {
        const p = document.createElement('div');
        p.className = 'status';
        p.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
        groupMemberPicker.appendChild(p);
      }
    }

    function renderGroups(groups) {
      groupsCache = groups;
      groupsEl.innerHTML = '';
      groups.forEach(g => {
        const btn = document.createElement('button');
        btn.textContent = `# ${g.name}`;
        const count = unreadGroups.get(g.id) || 0;
        if (count > 0) {
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = count;
          btn.appendChild(badge);
        }
        btn.onclick = () => openGroup(g);
        if (currentGroup === g.id) btn.classList.add('active');
        groupsEl.appendChild(btn);
      });
      updateGroupMenuVisibility();
    }

    function addGroupFromPush(group) {
      if (!group || !group.id) return;
      if (groupsCache.some(g => g.id === group.id)) return;
      groupsCache.push(group);
      renderGroups(groupsCache);
    }

    function handleGroupDeleted(groupId) {
      groupsCache = groupsCache.filter(g => g.id !== groupId);
      renderGroups(groupsCache);
      if (currentGroup === groupId) {
        currentGroup = null;
        delete conversations[`g:${groupId}`];
        chatTitle.textContent = '–ß–∞—Ç';
        chatEl.innerHTML = '';
        if (groupInfo) groupInfo.classList.add('hidden');
        setChatStatus('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
        updateGroupMenuVisibility();
        updateSidebar(true);
      }
    }

    function createAttachmentEl(m) {
      if (!m.attachment_url) return null;
      const wrap = document.createElement('div');
      wrap.className = 'attachment';
      const type = (m.attachment_type || '').toLowerCase();
      const name = m.attachment_name || '–í–ª–æ–∂–µ–Ω–∏–µ';
      if (type.startsWith('image')) {
        const img = document.createElement('img');
        img.src = m.attachment_url;
        img.alt = name;
        wrap.appendChild(img);
      } else if (type.startsWith('video')) {
        const vid = document.createElement('video');
        vid.src = m.attachment_url;
        vid.controls = true;
        wrap.appendChild(vid);
      } else {
        const link = document.createElement('a');
        link.href = m.attachment_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = name;
        wrap.appendChild(link);
      }
      return wrap;
    }

    function renderMessages(peerId) {
      chatEl.innerHTML = '';
      const msgs = conversations[peerId] || [];
      msgs.forEach(m => {
        const wrap = document.createElement('div');
        const isMe = m.sender_id === me.id;
        wrap.className = `msg ${isMe ? 'me' : 'other'}`;

        if (m.content) {
          const text = document.createElement('div');
          text.textContent = m.content;
          wrap.appendChild(text);
        }
        const att = createAttachmentEl(m);
        if (att) wrap.appendChild(att);

        const meta = document.createElement('div');
        meta.className = 'bubble-info';
        const date = new Date(m.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let ticks = '';
        if (m.sender_id === me?.id) {
          ticks = m.read_at ? ' ‚úì‚úì' : ' ‚úì';
        }
        meta.textContent = `${usernameById(m.sender_id)} ‚Ä¢ ${date}${ticks}`;
        wrap.appendChild(meta);

        chatEl.appendChild(wrap);
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function renderGroupMessages(groupId) {
      chatEl.innerHTML = '';
      const msgs = conversations[`g:${groupId}`] || [];
      msgs.forEach(m => {
        const wrap = document.createElement('div');
        const isMe = m.sender_id === me.id;
        wrap.className = `msg ${isMe ? 'me' : 'other'}`;

        if (m.content) {
          const text = document.createElement('div');
          text.textContent = m.content;
          wrap.appendChild(text);
        }
        const att = createAttachmentEl(m);
        if (att) wrap.appendChild(att);

        const meta = document.createElement('div');
        meta.className = 'bubble-info';
        const date = new Date(m.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let ticks = '';
        if (isMe) {
          const readers = m.read_by || [];
          ticks = readers.length ? ' ‚úì‚úì' : ' ‚úì';
        }
        meta.textContent = `${usernameById(m.sender_id, groupId)} ‚Ä¢ ${date}${ticks}`;
        wrap.appendChild(meta);

        chatEl.appendChild(wrap);
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function loadGroupMembers(groupId) {
      if (!groupId) return;
      try {
        const members = await api(`/groups/${groupId}/members`);
        groupMembersCache[groupId] = members;
        renderGroupMembersPanel(members);
      } catch (e) {
        if (groupInfo) {
          groupInfo.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
          groupInfo.classList.remove('hidden');
        }
      }
    }

    function renderGroupMembersPanel(members) {
      if (!groupInfo) return;
      const listEl = groupInfo.querySelector('.members-list');
      if (!listEl) return;
      if (!members || !members.length) {
        listEl.innerHTML = '–£—á–∞—Å—Ç–Ω–∏–∫–∏: —Ç–æ–ª—å–∫–æ –≤—ã';
        groupInfo.classList.remove('hidden');
        return;
      }
      listEl.innerHTML = `<strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</strong> ` + members.map(m => `<span class="member">${m.username}</span>`).join('');
      groupInfo.classList.remove('hidden');
      // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å —á–∞—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–∞—Ö
      setTimeout(() => {
        groupInfo.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }, 30);
    }

    async function loadUsers() {
      try {
        const users = await api('/users');
        renderUsers(users);
        renderGroupMemberPicker();
        setAuthStatus(`–í–æ—à–ª–∏ –∫–∞–∫ ${me.username} (id ${me.id})`);
      } catch (e) {
        setAuthStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + e.message);
      }
    }

    async function loadGroups() {
      try {
        const groups = await api('/groups');
        renderGroups(groups);
      } catch (e) {
        // –∏–≥–Ω–æ—Ä, –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
      }
    }

    async function openChat(user) {
      currentGroup = null;
      currentPeer = user.id;
      chatTitle.textContent = user.username;
      setChatStatus('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
      if (groupInfo) groupInfo.classList.add('hidden');
      unreadUsers.delete(user.id);
      renderUsers(usersCache);
      try {
        const history = await api(`/messages/${user.id}`);
        conversations[user.id] = history;
        renderMessages(user.id);
        setChatStatus('–û–Ω–ª–∞–π–Ω —á–∞—Ç');
        renderUsers(await api('/users'));
        await markRead(user.id);
        updateSidebar(false);
        updateGroupMenuVisibility();
      } catch (e) {
        setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ' + e.message);
      }
    }

    async function openGroup(group) {
      currentPeer = null;
      currentGroup = group.id;
      chatTitle.textContent = `# ${group.name}`;
      setChatStatus('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
      unreadGroups.delete(group.id);
      renderGroups(groupsCache);
      try {
        const history = await api(`/group_messages/${group.id}`);
        conversations[`g:${group.id}`] = history;
        renderGroupMessages(group.id);
        setChatStatus('–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç');
        await loadGroups();
        updateSidebar(false);
        updateGroupMenuVisibility();
        if (groupInfo) groupInfo.classList.add('hidden'); // –ø–æ–∫–∞–∂–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É
        await markGroupRead(group.id);
      } catch (e) {
        setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ' + e.message);
      }
    }

    function addIncomingMessage(msg) {
      const peerId = msg.sender_id === me.id ? msg.receiver_id : msg.sender_id;
      conversations[peerId] = conversations[peerId] || [];
      conversations[peerId].push(msg);
      if (peerId === currentPeer) {
        renderMessages(peerId);
        markRead(peerId);
      } else if (msg.sender_id !== me.id) {
        const prev = unreadUsers.get(peerId) || 0;
        unreadUsers.set(peerId, prev + 1);
        renderUsers(usersCache);
        updateTitleBadge();
        playBeep();
        if (document.hidden) {
          const body = msg.content || msg.attachment_name || '–í–ª–æ–∂–µ–Ω–∏–µ';
          maybeNotify(usernameById(msg.sender_id), body);
        }
      }
    }

    function addIncomingGroupMessage(msg) {
      const key = `g:${msg.group_id}`;
      conversations[key] = conversations[key] || [];
      conversations[key].push(msg);
      if (currentGroup === msg.group_id) {
        renderGroupMessages(msg.group_id);
        markGroupRead(msg.group_id);
      } else if (msg.sender_id !== me.id) {
        const prev = unreadGroups.get(msg.group_id) || 0;
        unreadGroups.set(msg.group_id, prev + 1);
        renderGroups(groupsCache);
        updateTitleBadge();
        playBeep();
        if (document.hidden) {
          const body = msg.content || msg.attachment_name || '–í–ª–æ–∂–µ–Ω–∏–µ';
          maybeNotify(usernameById(msg.sender_id, msg.group_id) + ' (–≥—Ä—É–ø–ø–∞)', body);
        }
      }
    }

    async function markGroupRead(groupId) {
      try {
        await api(`/group_messages/${groupId}/read`, { method: 'POST' });
        unreadGroups.set(groupId, 0);
        updateTitleBadge();
      } catch (e) {
        // ignore
      }
    }

    function addUserFromPush(user) {
      if (!user || !user.id) return;
      if (usersCache.some(u => u.id === user.id)) return;
      usersCache.push(user);
      usersCache.sort((a, b) => a.id - b.id);
      renderUsers(usersCache);
      renderGroupMemberPicker();
    }

    async function markRead(peerId) {
      try {
        await api(`/messages/${peerId}/read`, { method: 'POST' });
        const msgs = conversations[peerId] || [];
        const now = new Date().toISOString();
        msgs.forEach(m => {
          if (m.sender_id === peerId && !m.read_at) {
            m.read_at = now;
          }
        });
        renderMessages(peerId);
        unreadUsers.set(peerId, 0);
        updateTitleBadge();
      } catch (e) {
        // ignore
      }
    }

    function connectWs() {
      if (!token) return;
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
      const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${scheme}://${location.host}/ws?token=${encodeURIComponent(token)}`;
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        setStatus('WS connected');
        reconnectAttempts = 0;
        stopHeartbeat();
        startHeartbeat();
        flushQueue();
      };
      ws.onclose = () => {
        setStatus('WS disconnected');
        ws = null;
        stopHeartbeat();
        onlineUsers.clear();
        renderUsers(usersCache);
        scheduleReconnect();
      };
      ws.onerror = () => {
        setStatus('WS error');
        scheduleReconnect();
      };
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'message') addIncomingMessage(data);
          else if (data.type === 'group_message') addIncomingGroupMessage(data);
          else if (data.type === 'welcome') {
            setStatus(`WS connected as id ${data.user_id}`);
            if (data.online_ids) {
              onlineUsers.clear();
              data.online_ids.forEach((id) => onlineUsers.add(id));
              renderUsers(usersCache);
            }
          }
          else if (data.type === 'user_online') { onlineUsers.add(data.user_id); renderUsers(usersCache); }
          else if (data.type === 'user_offline') { onlineUsers.delete(data.user_id); renderUsers(usersCache); }
          else if (data.type === 'group_created' && data.group) {
            addGroupFromPush(data.group);
          } else if (data.type === 'group_deleted' && data.group_id) {
            handleGroupDeleted(data.group_id);
          } else if (data.type === 'user_created' && data.user) {
            addUserFromPush(data.user);
            loadUsers(); // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          } else if (data.type === 'typing') {
            const name = usernameById(data.sender_id);
            if (data.is_typing) {
              setChatStatus(`${name} –ø–µ—á–∞—Ç–∞–µ—Ç...`);
              setTimeout(() => setChatStatus('–û–Ω–ª–∞–π–Ω —á–∞—Ç'), 3000);
            } else {
              setChatStatus('–û–Ω–ª–∞–π–Ω —á–∞—Ç');
            }
          } else if (data.type === 'message_read' && data.message_ids) {
            const ids = data.message_ids;
            const now = new Date().toISOString();
            Object.keys(conversations).forEach(key => {
              conversations[key].forEach(m => {
                if (ids.includes(m.id)) m.read_at = now;
              });
            });
            if (currentPeer) renderMessages(currentPeer);
          }
          else if (data.type === 'signal') {
            if (data.signal_type === 'offer') handleOffer(data);
            if (data.signal_type === 'answer') handleAnswer(data);
            if (data.signal_type === 'ice') handleIce(data);
            if (data.signal_type === 'end') cleanupCall();
          }
        } catch (e) {
          console.error(e);
        }
      };
    }

    function getAuthValues() {
      const u1 = document.getElementById('landing-username')?.value || '';
      const p1 = document.getElementById('landing-password')?.value || '';
      const u2 = document.getElementById('username')?.value || '';
      const p2 = document.getElementById('password')?.value || '';
      return {
        username: (u1 || u2).trim(),
        password: (p1 || p2).trim(),
      };
    }

    async function doRegister() {
      const { username, password } = getAuthValues();
      if (!username || !password) return setAuthStatus('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
      try {
        await api('/register', { method: 'POST', body: JSON.stringify({ username, password }) });
        setAuthStatus('–ì–æ—Ç–æ–≤–æ, –≤—Ö–æ–¥–∏–º...');
        await doLogin();
      } catch (e) {
        setAuthStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + e.message);
      }
    }

    async function doLogin() {
      const { username, password } = getAuthValues();
      if (!username || !password) return setAuthStatus('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
      try {
        const res = await api('/login', { method: 'POST', body: JSON.stringify({ username, password }) });
        token = res.token;
        localStorage.setItem('token', token);
        await loadMe();
        connectWs();
        await loadUsers();
        await loadGroups();
        hideAuth();
        ensurePushSubscribed();
      } catch (e) {
        setAuthStatus('–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è: ' + e.message);
      }
    }

    async function loadMe() {
      try {
        me = await api('/me');
        setAuthStatus(`–í–æ—à–ª–∏ –∫–∞–∫ ${me.username} (id ${me.id})`);
      } catch (e) {
        setAuthStatus('–ù–µ –≤–æ—à–ª–∏');
        showAuth();
      }
    }

    async function sendMessage() {
      if (!currentPeer && !currentGroup) return setChatStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—É');
      const file = fileInputEl?.files?.[0];
      const content = messageInput.value.trim();
      let uploadMeta = null;
      try {
        if (file) {
          const fd = new FormData();
          fd.append('file', file);
          const res = await fetch('/upload', {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: fd,
          });
          if (!res.ok) {
            const msg = await res.text();
            setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ' + msg);
            return;
          }
          uploadMeta = await res.json();
          fileInputEl.value = '';
          if (fileChip) {
            fileChip.textContent = '';
            fileChip.classList.add('hidden');
          }
        }
      } catch (e) {
        setChatStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + e.message);
        return;
      }
      if (!content && !uploadMeta) {
        setChatStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        return;
      }
      const payloadBase = {
        content,
        attachment_url: uploadMeta?.url,
        attachment_type: uploadMeta?.content_type,
        attachment_name: uploadMeta?.name,
      };
      const wsPayload = currentGroup
        ? { type: 'group_message', group_id: currentGroup, ...payloadBase }
        : { receiver_id: currentPeer, ...payloadBase };
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(wsPayload));
      } else {
        enqueueMessage(wsPayload);
        setStatus('WS –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω, –æ—Ç–ø—Ä–∞–≤–∏–º –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏');
        connectWs();
      }
      messageInput.value = '';
      if (isTypingSent && currentPeer) {
        ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'typing', receiver_id: currentPeer, is_typing: false }));
        isTypingSent = false;
      }
    }

    document.getElementById('btn-register').onclick = doRegister;
    document.getElementById('btn-login').onclick = doLogin;
    const landingRegister = document.getElementById('landing-register');
    const landingLogin = document.getElementById('landing-login');
    if (landingRegister) landingRegister.onclick = doRegister;
    if (landingLogin) landingLogin.onclick = doLogin;
    if (logoutBtn) logoutBtn.onclick = logout;
    document.getElementById('btn-create-group').onclick = async () => {
      const name = document.getElementById('group-name').value.trim();
      const member_usernames = [];
      if (groupMemberPicker) {
        groupMemberPicker.querySelectorAll('input[type=\"checkbox\"]').forEach(cb => {
          if (cb.checked) member_usernames.push(cb.value);
        });
      }
      if (!name) return;
      try {
        await api('/groups', {
          method: 'POST',
          body: JSON.stringify({ name, member_usernames }),
        });
        document.getElementById('group-name').value = '';
        if (groupMemberPicker) groupMemberPicker.querySelectorAll('input[type=\"checkbox\"]').forEach(cb => cb.checked = false);
        await loadGroups();
      } catch (e) {
        setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É: ' + e.message);
      }
    };
    document.getElementById('send-btn').onclick = sendMessage;
    if (fileInputEl) {
      fileInputEl.addEventListener('change', () => {
        const f = fileInputEl.files?.[0];
        if (f && fileChip) {
          const sizeMb = (f.size / (1024 * 1024)).toFixed(1);
          fileChip.textContent = `${f.name} (${sizeMb} –ú–ë)`;
          const clearBtn = document.createElement('button');
          clearBtn.textContent = '√ó';
          clearBtn.onclick = () => {
            fileInputEl.value = '';
            fileChip.textContent = '';
            fileChip.classList.add('hidden');
          };
          fileChip.appendChild(clearBtn);
          fileChip.classList.remove('hidden');
        } else if (fileChip) {
          fileChip.textContent = '';
          fileChip.classList.add('hidden');
        }
      });
    }
    messageInput.addEventListener('keydown', (e) => {
      if (currentPeer && !currentGroup) {
        if (!isTypingSent) {
          ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'typing', receiver_id: currentPeer, is_typing: true }));
          isTypingSent = true;
        }
        clearTimeout(typingTimers.get(currentPeer));
        const t = setTimeout(() => {
          ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'typing', receiver_id: currentPeer, is_typing: false }));
          isTypingSent = false;
        }, 3000);
        typingTimers.set(currentPeer, t);
      } else if (currentGroup) {
        ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'group_typing', group_id: currentGroup, is_typing: true }));
        clearTimeout(groupTypingTimers.get(currentGroup));
        const t = setTimeout(() => {
          ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'group_typing', group_id: currentGroup, is_typing: false }));
        }, 3000);
        groupTypingTimers.set(currentGroup, t);
      }
      if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('call-audio').onclick = () => startCall('audio');
    document.getElementById('call-video').onclick = () => startCall('video');
    document.getElementById('call-end').onclick = () => cleanupCall(true);
    if (groupMenuBtn) groupMenuBtn.onclick = deleteCurrentGroup;
    if (groupInfoClose) groupInfoClose.onclick = () => { if (groupInfo) groupInfo.classList.add('hidden'); };
    chatTitle.addEventListener('click', async () => {
      if (currentGroup) {
        const isVisible = groupInfo && !groupInfo.classList.contains('hidden');
        if (isVisible) {
          groupInfo.classList.add('hidden');
        } else {
          await loadGroupMembers(currentGroup);
        }
      }
    });
    ensureAudioUnlocked();
    requestNotifyPermission();
    toggleContactsBtn.addEventListener('click', () => {
      const show = !sidebar.classList.contains('show');
      updateSidebar(show);
    });

    (async function init() {
      if (token) {
        await loadMe();
        if (me) {
          connectWs();
          await loadUsers();
          await loadGroups();
          hideAuth();
          ensurePushSubscribed();
        }
      } else {
        setAuthStatus('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        showAuth();
      }
    })();

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker –¥–ª—è PWA (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –∫–µ—à-—Å—Ç–∞—Ç–∏–∫)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(console.error);
      });
    }

    function logout() {
      cleanupCall(true);
      if (ws) {
        try { ws.close(); } catch (e) {}
      }
      unsubscribePush();
      ws = null;
      token = '';
      me = null;
      currentPeer = null;
      currentGroup = null;
      usersEl.innerHTML = '';
      groupsEl.innerHTML = '';
      chatEl.innerHTML = '';
      chatTitle.textContent = '–ß–∞—Ç';
      setStatus('Not connected');
      setAuthStatus('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
      setChatStatus('–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
      localStorage.removeItem('token');
      showAuth();
      updateSidebar(false);
      if (groupInfo) groupInfo.classList.add('hidden');
      updateGroupMenuVisibility();
    }
  </script>
</body>
</html>
